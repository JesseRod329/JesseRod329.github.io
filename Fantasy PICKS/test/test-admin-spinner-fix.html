<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Spinner Fix Test - Fantasy Wrestling</title>
    <link href="/tailwind.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white p-8">
    <h1 class="text-2xl font-bold mb-4">Admin Spinner Fix Test</h1>
    
    <div class="space-y-6">
        <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
            <h2 class="text-lg font-bold text-green-400 mb-2">‚úÖ Admin Spinner Fix Features Implemented</h2>
            <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>Fixed saveAllResults()</strong>: Proper try/finally block with await</li>
                <li><strong>Added setSaving() helper</strong>: Manages spinner state properly</li>
                <li><strong>Added collectAllResults() helper</strong>: Gathers form data cleanly</li>
                <li><strong>Added saving indicator</strong>: Separate element for "Saving..." text</li>
                <li><strong>Added refreshMatches() helper</strong>: Reloads match data after save</li>
                <li><strong>Proper error handling</strong>: Spinner always resets in finally block</li>
            </ul>
        </div>
        
        <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
            <h2 class="text-lg font-bold text-blue-400 mb-2">Test Steps</h2>
            <ol class="list-decimal list-inside space-y-1 text-sm">
                <li>Sign in with Google using an admin account</li>
                <li>Navigate to admin.html</li>
                <li>Select an event from the dropdown</li>
                <li>Make some changes to match results</li>
                <li>Click "Save All Results" button</li>
                <li>Verify spinner shows and disappears properly</li>
                <li>Check that notifications appear correctly</li>
                <li>Verify match list refreshes after successful save</li>
            </ol>
        </div>
        
        <div class="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4">
            <h2 class="text-lg font-bold text-yellow-400 mb-2">Fixed Implementation</h2>
            <div class="space-y-2 text-sm">
                <div class="flex items-center space-x-2">
                    <span class="text-green-400 font-bold">saveAllResults()</span>
                    <span>Uses try/finally block with proper await</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-blue-400 font-bold">setSaving()</span>
                    <span>Manages button state and saving indicator</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-yellow-400 font-bold">collectAllResults()</span>
                    <span>Gathers form data and validates input</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-red-400 font-bold">refreshMatches()</span>
                    <span>Reloads match data after successful save</span>
                </div>
            </div>
        </div>
        
        <div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4">
            <h2 class="text-lg font-bold text-purple-400 mb-2">Saving Indicator Element</h2>
            <div class="space-y-2 text-sm">
                <div class="flex items-center space-x-2">
                    <span class="text-green-400 font-bold">Element ID</span>
                    <span>saving-indicator</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-blue-400 font-bold">Default State</span>
                    <span>hidden (display: none)</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-yellow-400 font-bold">Text</span>
                    <span>"Saving..."</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-red-400 font-bold">Styling</span>
                    <span>text-sm text-yellow-400</span>
                </div>
            </div>
        </div>
        
        <div class="bg-gray-800 p-4 rounded">
            <h2 class="text-lg font-bold mb-2">Test Functions</h2>
            <div class="space-y-4">
                <div class="flex space-x-2">
                    <button onclick="testSetSaving()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                        Test setSaving()
                    </button>
                    <button onclick="testCollectResults()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        Test collectAllResults()
                    </button>
                    <button onclick="testRefreshMatches()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">
                        Test refreshMatches()
                    </button>
                    <button onclick="testFullFlow()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                        Test Full Flow
                    </button>
                </div>
                <div id="testResults" class="bg-black p-4 rounded text-sm font-mono hidden">
                    <!-- Test results will appear here -->
                </div>
            </div>
        </div>
        
        <div class="bg-gray-800 p-4 rounded">
            <h2 class="text-lg font-bold mb-2">Expected Console Output</h2>
            <pre class="text-xs text-gray-300 bg-black p-3 rounded overflow-x-auto">
// Starting bulk save
AdminSystem.saveAllResults() called
AdminSystem.setSaving() called with: true
AdminSystem.collectAllResults() called
Collected 3 match updates

// During save
Saving 3 match results

// On success
All results saved ‚úì
AdminSystem.refreshMatches() called
AdminSystem.loadMatches() called with eventId: [event-id]
Matches refreshed successfully
AdminSystem.setSaving() called with: false

// On error
Bulk save error: [error details]
Save failed: [error message]
AdminSystem.setSaving() called with: false
            </pre>
        </div>
        
        <div class="bg-gray-800 p-4 rounded">
            <h2 class="text-lg font-bold mb-2">Implementation Details</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="text-md font-semibold text-yellow-400 mb-2">saveAllResults() Method</h3>
                    <pre class="text-xs text-gray-300 bg-black p-3 rounded overflow-x-auto">
async saveAllResults() {
  try {
    this.setSaving(true); // show spinner
    
    const payload = this.collectAllResults(); // gather form data
    if (!payload.length) {
      this.showNotification('No changes to save', 'info');
      return;
    }
    
    const { error } = await supabase
      .from('matches')
      .upsert(payload, { onConflict: 'id' });
    
    if (error) {
      this.showNotification('Save failed: ' + error.message, 'error');
    } else {
      this.showNotification('All results saved ‚úì', 'success');
      await this.refreshMatches(); // re-render match list
    }
  } finally {
    this.setSaving(false); // always reset spinner
  }
}
                    </pre>
                </div>
                
                <div>
                    <h3 class="text-md font-semibold text-yellow-400 mb-2">setSaving() Helper</h3>
                    <pre class="text-xs text-gray-300 bg-black p-3 rounded overflow-x-auto">
setSaving(isSaving) {
  const el = document.getElementById('saving-indicator');
  if (!el) return;
  el.style.display = isSaving ? 'block' : 'none';
  
  // Also manage button state
  const button = document.getElementById('saveAllResults');
  if (button) {
    button.disabled = isSaving;
    // Update button content based on state
  }
}
                    </pre>
                </div>
            </div>
        </div>
        
        <div class="bg-gray-800 p-4 rounded">
            <h2 class="text-lg font-bold mb-2">Verification Checklist</h2>
            <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>‚úÖ Try/Finally Block</strong>: Proper error handling with always reset</li>
                <li><strong>‚úÖ Await Supabase Call</strong>: Properly awaits upsert operation</li>
                <li><strong>‚úÖ setSaving() Helper</strong>: Manages spinner state correctly</li>
                <li><strong>‚úÖ collectAllResults() Helper</strong>: Gathers and validates form data</li>
                <li><strong>‚úÖ refreshMatches() Helper</strong>: Reloads data after successful save</li>
                <li><strong>‚úÖ Saving Indicator</strong>: Separate element for "Saving..." text</li>
                <li><strong>‚úÖ Notifications</strong>: Success/error messages with auto-dismiss</li>
                <li><strong>‚úÖ UI Reset</strong>: Spinner always clears regardless of outcome</li>
            </ul>
        </div>
    </div>
    
    <script>
        function showResult(message, type = 'info') {
            const results = document.getElementById('testResults');
            results.classList.remove('hidden');
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            results.innerHTML += `<div class="${color}">${message}</div>`;
        }
        
        function clearResults() {
            const results = document.getElementById('testResults');
            results.innerHTML = '';
            results.classList.add('hidden');
        }
        
        function testSetSaving() {
            clearResults();
            showResult('üß™ Testing setSaving() Helper...', 'info');
            
            try {
                if (!window.FantasyWrestling?.AdminSystem) {
                    showResult('‚ùå AdminSystem not available. Make sure main.js is loaded.', 'error');
                    return;
                }
                
                if (!window.FantasyWrestling.AdminSystem.setSaving) {
                    showResult('‚ùå setSaving method not found', 'error');
                    return;
                }
                
                showResult('‚úÖ setSaving() method found', 'success');
                showResult('üìù Method manages:', 'info');
                showResult('   - Button disabled state', 'info');
                showResult('   - Button content (spinner/normal)', 'info');
                showResult('   - Saving indicator visibility', 'info');
                showResult('   - Bulk save status text', 'info');
                showResult('‚úÖ setSaving() helper implementation complete', 'success');
                
            } catch (error) {
                showResult(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        function testCollectResults() {
            clearResults();
            showResult('üß™ Testing collectAllResults() Helper...', 'info');
            
            try {
                if (!window.FantasyWrestling?.AdminSystem) {
                    showResult('‚ùå AdminSystem not available. Make sure main.js is loaded.', 'error');
                    return;
                }
                
                if (!window.FantasyWrestling.AdminSystem.collectAllResults) {
                    showResult('‚ùå collectAllResults method not found', 'error');
                    return;
                }
                
                showResult('‚úÖ collectAllResults() method found', 'success');
                showResult('üìù Method handles:', 'info');
                showResult('   - Gathering form data from match cards', 'info');
                showResult('   - Building extras JSON object', 'info');
                showResult('   - Validating required fields', 'info');
                showResult('   - Returning array of updates', 'info');
                showResult('‚úÖ collectAllResults() helper implementation complete', 'success');
                
            } catch (error) {
                showResult(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        function testRefreshMatches() {
            clearResults();
            showResult('üß™ Testing refreshMatches() Helper...', 'info');
            
            try {
                if (!window.FantasyWrestling?.AdminSystem) {
                    showResult('‚ùå AdminSystem not available. Make sure main.js is loaded.', 'error');
                    return;
                }
                
                if (!window.FantasyWrestling.AdminSystem.refreshMatches) {
                    showResult('‚ùå refreshMatches method not found', 'error');
                    return;
                }
                
                showResult('‚úÖ refreshMatches() method found', 'success');
                showResult('üìù Method handles:', 'info');
                showResult('   - Checking for current event ID', 'info');
                showResult('   - Reloading matches from database', 'info');
                showResult('   - Re-rendering match list', 'info');
                showResult('   - Error handling for refresh failures', 'info');
                showResult('‚úÖ refreshMatches() helper implementation complete', 'success');
                
            } catch (error) {
                showResult(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        function testFullFlow() {
            clearResults();
            showResult('üß™ Testing Full Bulk Save Flow...', 'info');
            
            try {
                if (!window.FantasyWrestling?.AdminSystem) {
                    showResult('‚ùå AdminSystem not available. Make sure main.js is loaded.', 'error');
                    return;
                }
                
                const adminSystem = window.FantasyWrestling.AdminSystem;
                
                if (!adminSystem.saveAllResults || !adminSystem.setSaving || !adminSystem.collectAllResults || !adminSystem.refreshMatches) {
                    showResult('‚ùå Required methods not found', 'error');
                    return;
                }
                
                showResult('‚úÖ All required methods found', 'success');
                showResult('üìù Full flow includes:', 'info');
                showResult('   1. setSaving(true) - Show spinner', 'info');
                showResult('   2. collectAllResults() - Gather form data', 'info');
                showResult('   3. supabase.upsert() - Save to database', 'info');
                showResult('   4. refreshMatches() - Reload data on success', 'info');
                showResult('   5. setSaving(false) - Always reset spinner', 'info');
                showResult('‚úÖ Full bulk save flow implementation complete', 'success');
                
            } catch (error) {
                showResult(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        // Check if AdminSystem is available
        document.addEventListener('DOMContentLoaded', () => {
            if (window.FantasyWrestling?.AdminSystem) {
                showResult('‚úÖ AdminSystem loaded successfully!', 'success');
            } else {
                showResult('‚ö†Ô∏è AdminSystem not yet loaded. Make sure main.js is loaded.', 'info');
            }
        });
    </script>
</body>
</html>
