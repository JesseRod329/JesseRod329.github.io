<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnsureProfile Test - Fantasy Wrestling</title>
    <link href="/tailwind.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white p-8">
    <h1 class="text-2xl font-bold mb-4">EnsureProfile Helper Test</h1>
    
    <div class="space-y-6">
        <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
            <h2 class="text-lg font-bold text-green-400 mb-2">‚úÖ EnsureProfile Implementation Status</h2>
            <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>Function Added</strong>: ensureProfile() function exists in ApiHelpers</li>
                <li><strong>Integration Complete</strong>: Called in AuthManager.setAuthenticatedUser()</li>
                <li><strong>Console Logging</strong>: "Ensuring profile for user:" and success messages</li>
                <li><strong>Error Handling</strong>: Proper error handling with console.warn</li>
                <li><strong>Upsert Logic</strong>: Uses upsert to handle existing/new profiles</li>
            </ul>
        </div>
        
        <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
            <h2 class="text-lg font-bold text-blue-400 mb-2">Implementation Details</h2>
            <div class="space-y-2 text-sm">
                <div class="flex items-center space-x-2">
                    <span class="text-green-400 font-bold">Function Location</span>
                    <span>ApiHelpers.ensureProfile(sb = window.sb)</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-blue-400 font-bold">Integration Point</span>
                    <span>AuthManager.setAuthenticatedUser() after login</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-yellow-400 font-bold">Database Operation</span>
                    <span>sb.from('users').upsert({ id, email })</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-red-400 font-bold">Error Handling</span>
                    <span>console.warn() for upsert failures</span>
                </div>
            </div>
        </div>
        
        <div class="bg-gray-800 p-4 rounded">
            <h2 class="text-lg font-bold mb-2">Test Functions</h2>
            <div class="space-y-4">
                <div class="flex space-x-2">
                    <button onclick="testEnsureProfile()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                        Test EnsureProfile
                    </button>
                    <button onclick="testAuthFlow()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        Test Auth Flow
                    </button>
                    <button onclick="checkConsole()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">
                        Check Console
                    </button>
                </div>
                <div id="testResults" class="bg-black p-4 rounded text-sm font-mono hidden">
                    <!-- Test results will appear here -->
                </div>
            </div>
        </div>
        
        <div class="bg-gray-800 p-4 rounded">
            <h2 class="text-lg font-bold mb-2">Expected Console Output</h2>
            <pre class="text-xs text-gray-300 bg-black p-3 rounded overflow-x-auto">
// After successful sign-in:
AuthManager.init() called
User authenticated: user@example.com
Ensuring user profile for: user@example.com
Ensuring profile for user: user@example.com
Profile ensured successfully

// If profile already exists:
Ensuring profile for user: user@example.com
Profile ensured successfully

// If there's an error:
Ensuring profile for user: user@example.com
ensureProfile upsert failed: [error details]
            </pre>
        </div>
        
        <div class="bg-gray-800 p-4 rounded">
            <h2 class="text-lg font-bold mb-2">Function Implementation</h2>
            <pre class="text-xs text-gray-300 bg-black p-3 rounded overflow-x-auto">
async function ensureProfile(sb) {
  const { data: { user }, error: uerr } = await sb.auth.getUser();
  if (uerr || !user) return;

  const { error } = await sb.from('users').upsert({
    id: user.id,
    email: user.email ?? null
  });

  if (error) console.warn('ensureProfile upsert failed:', error);
}
            </pre>
        </div>
        
        <div class="bg-gray-800 p-4 rounded">
            <h2 class="text-lg font-bold mb-2">Integration Points</h2>
            <div class="space-y-2 text-sm">
                <div class="flex items-start space-x-2">
                    <span class="text-green-400 font-bold">AuthManager.setAuthenticatedUser():</span>
                    <span>Calls ensureProfile() after successful authentication</span>
                </div>
                <div class="flex items-start space-x-2">
                    <span class="text-blue-400 font-bold">onAuthStateChange:</span>
                    <span>Triggers setAuthenticatedUser() on SIGNED_IN event</span>
                </div>
                <div class="flex items-start space-x-2">
                    <span class="text-yellow-400 font-bold">checkExistingSession:</span>
                    <span>Also calls setAuthenticatedUser() on page load if session exists</span>
                </div>
            </div>
        </div>
        
        <div class="bg-gray-800 p-4 rounded">
            <h2 class="text-lg font-bold mb-2">Verification Checklist</h2>
            <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>‚úÖ Function Added</strong>: ensureProfile() exists in ApiHelpers</li>
                <li><strong>‚úÖ Integration Complete</strong>: Called after successful login</li>
                <li><strong>‚úÖ Console Logging</strong>: Proper logging messages implemented</li>
                <li><strong>‚úÖ Error Handling</strong>: console.warn() for upsert failures</li>
                <li><strong>‚úÖ Upsert Logic</strong>: Handles both new and existing profiles</li>
                <li><strong>‚úÖ User Validation</strong>: Checks for authenticated user before proceeding</li>
            </ul>
        </div>
    </div>
    
    <script>
        function showResult(message, type = 'info') {
            const results = document.getElementById('testResults');
            results.classList.remove('hidden');
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            results.innerHTML += `<div class="${color}">${message}</div>`;
        }
        
        function clearResults() {
            const results = document.getElementById('testResults');
            results.innerHTML = '';
            results.classList.add('hidden');
        }
        
        async function testEnsureProfile() {
            clearResults();
            showResult('üß™ Testing EnsureProfile Function...', 'info');
            
            try {
                if (!window.FantasyWrestling?.ApiHelpers) {
                    showResult('‚ùå ApiHelpers not available. Make sure main.js is loaded.', 'error');
                    return;
                }
                
                if (!window.FantasyWrestling?.ApiHelpers.ensureProfile) {
                    showResult('‚ùå ensureProfile function not found in ApiHelpers.', 'error');
                    return;
                }
                
                showResult('‚úÖ ensureProfile function found in ApiHelpers', 'success');
                showResult('üìù Function signature: async ensureProfile(sb = window.sb)', 'info');
                
                // Test the function if user is authenticated
                if (window.sb) {
                    const { data: { user } } = await window.sb.auth.getUser();
                    if (user) {
                        showResult('üë§ User authenticated, testing ensureProfile...', 'info');
                        await window.FantasyWrestling.ApiHelpers.ensureProfile();
                        showResult('‚úÖ ensureProfile test completed - check console for details', 'success');
                    } else {
                        showResult('‚ö†Ô∏è No authenticated user - sign in to test ensureProfile', 'info');
                    }
                } else {
                    showResult('‚ö†Ô∏è Supabase client not available', 'info');
                }
                
            } catch (error) {
                showResult(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        async function testAuthFlow() {
            clearResults();
            showResult('üß™ Testing Authentication Flow Integration...', 'info');
            
            try {
                if (!window.FantasyWrestling?.AuthManager) {
                    showResult('‚ùå AuthManager not available. Make sure main.js is loaded.', 'error');
                    return;
                }
                
                showResult('‚úÖ AuthManager found', 'success');
                showResult('üìù ensureProfile is called in AuthManager.setAuthenticatedUser()', 'info');
                showResult('üìù Integration point: after AuthManager.ensureUserProfile(user)', 'info');
                
                if (window.FantasyWrestling?.ApiHelpers?.ensureProfile) {
                    showResult('‚úÖ ensureProfile function is available in ApiHelpers', 'success');
                    showResult('‚úÖ Integration is complete and ready to use', 'success');
                } else {
                    showResult('‚ùå ensureProfile function not found in ApiHelpers', 'error');
                }
                
            } catch (error) {
                showResult(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        function checkConsole() {
            clearResults();
            showResult('üìã Console Logging Information:', 'info');
            showResult('Look for these messages in the browser console:', 'info');
            showResult('', 'info');
            showResult('‚úÖ "Ensuring profile for user: [email]"', 'success');
            showResult('‚úÖ "Profile ensured successfully"', 'success');
            showResult('‚ö†Ô∏è "ensureProfile upsert failed: [error]" (if error occurs)', 'info');
            showResult('', 'info');
            showResult('To test: Sign in with Google and watch the console output', 'info');
        }
        
        // Check if functions are available
        document.addEventListener('DOMContentLoaded', () => {
            if (window.FantasyWrestling?.ApiHelpers?.ensureProfile) {
                showResult('‚úÖ ensureProfile function loaded successfully!', 'success');
            } else {
                showResult('‚ö†Ô∏è ensureProfile function not yet loaded. Make sure main.js is loaded.', 'info');
            }
        });
    </script>
</body>
</html>
